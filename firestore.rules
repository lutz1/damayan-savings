rules_version = '2'; 
service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================
    // ðŸ”¹ Helper: Get current user's role
    function userRole() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role.lower()
        : "";
    }

    // ==========================================
    // ðŸ‘¤ USERS
    match /users/{userId} {

      // Allow reading user profiles (safe fields only)
      // Any authenticated user can read (merchants can read their own or any user)
      allow read: if request.auth != null;

      // List users:
      // - Admin/CEO can list for management screens
      // - Others can only run bounded username-prefix search
      allow list: if request.auth != null && (
        userRole() in ["admin", "ceo"] ||
        (
          request.query.limit <= 10 &&
          request.query.where("username", ">=") &&
          request.query.where("username", "<=")
        )
      );

      // CREATE
      allow create: if request.auth != null && userRole() in ["admin", "ceo"];

      // UPDATE - Allow admin SDK (no auth context) OR user updating their own OR admin/ceo (including merchants)
      allow update: if (
        // Admin SDK (server-side)
        request.auth == null ||
        // User updating their own profile or merchant updating their profile
        (
          request.auth.uid == userId &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            "eWallet",
            "eWalletBalance",
            "capitalShareActive",
            "capitalActivatedAt",
            "capitalProfitBalance",
            "lastActive",
            "notificationsSeen",
            "profilePicture",
            "onlineStatus",
            "name",
            "contactNumber",
            "address",
            "username",
            "updatedAt",
            "storeName",
            "storeDescription",
            "phone",
            "email",
            "city",
            "coverImage",
            "logo"
          ])
        ) ||
        // Admin/CEO
        userRole() in ["admin", "ceo"]
      );
    }

    // ==========================================
    // ðŸ“© PENDING INVITES
    match /pendingInvites/{inviteId} {
      allow read: if request.auth != null &&
        (userRole() in ["admin", "ceo"] || resource.data.inviterId == request.auth.uid);

      allow create: if request.auth != null &&
        (userRole() in ["admin", "ceo"] || request.resource.data.inviterId == request.auth.uid);

      allow update, delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ==========================================
    // ðŸ’¸ REFERRAL REWARDS
    match /referralReward/{rewardId} {
      allow read: if request.auth != null &&
        (resource.data.userId == request.auth.uid || userRole() in ["admin", "ceo"]);

      allow create: if request.auth != null &&
        request.resource.data.keys().hasAll([
          "userId", "username", "role", "amount",
          "source", "type", "approved",
          "payoutReleased", "createdAt"
        ]);

      allow update: if (
        // Allow server-side (Admin SDK with no auth context) to update transferred status
        request.auth == null ||
        // Allow admin/ceo to update anything
        (request.auth != null && userRole() in ["admin", "ceo"]) ||
        // Allow user to update their own reward's transfer status
        (
          request.auth != null &&
          resource.data.userId == request.auth.uid &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            "approved",
            "payoutReleased",
            "updatedAt",
            "transferredAmount",  
            "dateTransferred"    
          ])
        )
      );

      allow delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ==========================================
    // ðŸ“‹ REFERRAL REWARD TRANSFER LOGS
    match /referralRewardTransferlogs/{logId} {
      allow read: if request.auth != null &&
        (resource.data.userId == request.auth.uid || userRole() in ["admin", "ceo"]);

      allow list: if request.auth != null && (
        userRole() in ["admin", "ceo"] ||
        request.query.where("userId", "==", request.auth.uid)
      );

      // Only server-side (Admin SDK) can create transfer logs
      allow create: if request.auth == null;

      allow delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ==========================================
    // ï¿½ UPLINE REWARDS
    match /uplineRewards/{rewardId} {
      // Allow upline to read their own rewards
      allow read: if request.auth != null &&
        (resource.data.uplineId == request.auth.uid || userRole() in ["admin", "ceo"]);

      // Allow listing rewards for current upline
      allow list: if request.auth != null &&
        request.query.where("uplineId", "==", request.auth.uid);

      // Only server (Admin SDK) can create upline rewards
      allow create: if request.auth == null;

      // Allow upline to claim/update their rewards
      allow update: if request.auth != null &&
        (
          (resource.data.uplineId == request.auth.uid &&
            request.resource.data.diff(resource.data).affectedKeys().hasOnly([
              "claimed",
              "claimedAt",
              "transferredAmount",
              "status",
              "updatedAt"
            ])
          ) ||
          userRole() in ["admin", "ceo"]
        );

      // Only admins can delete
      allow delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    match /paybackEntries/{docId} {
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          resource.data.uplineUsername ==
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.username
        ) ||
        userRole() in ["admin", "ceo"]
      );

      allow list: if request.auth != null && (
        userRole() in ["admin", "ceo"] ||
        request.query.where("userId", "==", request.auth.uid)
      );

      allow create: if request.auth != null &&
        (request.resource.data.userId == request.auth.uid || userRole() in ["admin", "ceo"]);

      allow update: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          resource.data.uplineUsername ==
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.username
        ) ||
        userRole() in ["admin", "ceo"]
      );

      allow delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ==========================================
    // ðŸ’° CAPITAL SHARE ENTRIES
    match /capitalShareEntries/{docId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null &&
        request.resource.data.userId == request.auth.uid;
    }

    // ==========================================
    // ðŸ’¹ CAPITAL SHARE PROFITS
    match /capitalShareProfits/{docId} {
      allow read, create, update: if request.auth != null &&
        (resource.data.userId == request.auth.uid || userRole() in ["admin", "ceo"]);
    }

    // ==========================================
    // ðŸ§¾ PURCHASE CODES
    match /purchaseCodes/{docId} {
      allow read: if request.auth != null &&
        (resource.data.userId == request.auth.uid || userRole() in ["admin", "ceo"]);

      allow list: if request.auth != null && (
        userRole() in ["admin", "ceo"] ||
        request.query.where("userId", "==", request.auth.uid)
      );

      allow create: if request.auth != null &&
        (request.resource.data.userId == request.auth.uid || userRole() in ["admin", "ceo"]);

      allow update: if request.auth != null &&
        (
          userRole() in ["admin", "ceo"] ||
          (
            resource.data.userId == request.auth.uid &&
            resource.data.used == false &&
            request.resource.data.used == true
          )
        );

      allow delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ==========================================
    // ðŸ“¥ REQUESTS
    match /requests/{docId} {
      allow read, write: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ==========================================
    // ðŸ“Š PAYBACK PROFIT HISTORY
    match /paybackProfitHistory/{docId} {
      allow read, create: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ==========================================
    // ðŸ”„ PASSIVE TRANSFERS
    match /passiveTransfers/{docId} {
      allow read, create: if request.auth != null &&
        (resource.data.userId == request.auth.uid || userRole() in ["admin", "ceo"]);
    }

    // ==========================================
    // ðŸ’¼ OVERRIDE (upline rewards)
    match /override/{docId} {
      allow read, list: if request.auth != null && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.uplineId == request.auth.uid ||
        userRole() in ["admin", "ceo"]
      );

      allow create: if request.auth != null &&
        (request.resource.data.fromUserId == request.auth.uid || userRole() in ["admin", "ceo"]);

      allow update, delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ==========================================
    // ðŸ’¼ TRANSFER TRANSACTIONS
    match /transferTransactions/{docId} {
      allow read, write: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ==========================================
    // ðŸ’³ WALLETS
    match /wallets/{walletId} {
      allow read: if request.auth != null &&
        (resource.data.userId == request.auth.uid || userRole() in ["admin", "ceo"]);

      allow create: if request.auth != null &&
        request.resource.data.userId == request.auth.uid;

      allow update: if request.auth != null &&
        (resource.data.userId == request.auth.uid || userRole() in ["admin", "ceo"]);

      allow delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ==========================================
    // ðŸ’µ DEPOSITS
    match /deposits/{docId} {
      allow read: if request.auth != null &&
        (resource.data.userId == request.auth.uid || userRole() in ["admin", "ceo"]);

      allow create: if (
        // Allow Admin SDK (server-side) to create deposit records
        request.auth == null ||
        // Allow users to create their own deposits
        (request.auth != null && request.resource.data.userId == request.auth.uid)
      );

      allow update, delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ==========================================
    // ðŸ’µ WITHDRAWALS
    match /withdrawals/{docId} {
      allow read: if request.auth != null &&
        (resource.data.userId == request.auth.uid || userRole() in ["admin", "ceo"]);

      allow create: if request.auth != null &&
        request.resource.data.userId == request.auth.uid;

      allow update, delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ==========================================
    // ðŸ’¸ WALLET-TO-WALLET TRANSFERS
    match /transferFunds/{docId} {
      allow read: if request.auth != null && (
        resource.data.senderId == request.auth.uid ||
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          resource.data.recipientUsername ==
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.username
        ) ||
        userRole() in ["admin", "ceo"]
      );

      allow list: if request.auth != null &&
        request.query.where("senderId", "==", request.auth.uid);

      // Allow server-side (Admin SDK with no auth) to create approved transfers
      allow create: if request.auth == null || 
        (
          request.auth != null &&
          request.resource.data.senderId == request.auth.uid &&
          request.resource.data.amount is number &&
          request.resource.data.charge is number &&
          request.resource.data.netAmount is number &&
          request.resource.data.status == "Pending"
        );

      allow update, delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ðŸ›ï¸ PRODUCTS
    match /products/{productId} {
      allow create: if request.auth != null &&
        request.resource.data.merchantId == request.auth.uid;

      allow read: if resource.data.status == "active" ||
        (request.auth != null && (resource.data.merchantId == request.auth.uid || userRole() in ["admin", "ceo"]));

      allow update, delete: if request.auth != null &&
        (
          (resource.data.merchantId == request.auth.uid &&
            request.resource.data.diff(resource.data).affectedKeys().hasOnly([
              "name", "category", "description", "price", "stock", "image", "status", "updatedAt"
            ])
          ) ||
          userRole() in ["admin", "ceo"]
        );
    }

    // ðŸ’° SALES
    match /sales/{saleId} {
      allow read: if request.auth != null &&
        (resource.data.merchantId == request.auth.uid || userRole() in ["admin", "ceo"]);

      allow create, update, delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ðŸ’¬ FEEDBACK
    match /feedback/{feedbackId} {
      allow read: if request.auth != null &&
        (resource.data.merchantId == request.auth.uid || userRole() in ["admin", "ceo"]);

      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ðŸª MERCHANTS (store profiles)
    match /merchants/{merchantId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null &&
        (request.auth.uid == merchantId || userRole() in ["admin", "ceo"]);
      allow delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }
    
    // ==========================================
    // ðŸ›’ SHOP CATEGORIES
    match /shopCategories/{categoryId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }

        // ==========================================
    // ï¿½ OVERRIDE TRANSACTIONS
    match /overrideTransactions/{docId} {
      allow read: if request.auth != null &&
        (resource.data.userId == request.auth.uid || userRole() in ["admin", "ceo"]);

      allow list: if request.auth != null &&
        request.query.where("userId", "==", request.auth.uid);

      allow create: if request.auth == null; // Allow server-side (Admin SDK) only

      allow update, delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ==========================================
    // ï¿½ðŸ”” NOTIFICATIONS
    match /notifications/{notifId} {
      // Allow users to read their own notifications
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      // Allow users to create their own notifications
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      // Optionally, allow update/delete for marking as read or cleanup
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // ==========================================
    // ï¿½ DELIVERIES
    match /deliveries/{deliveryId} {
      allow read: if request.auth != null &&
        (resource.data.riderId == request.auth.uid || userRole() in ["admin", "ceo"]);

      allow list: if request.auth != null && (
        userRole() in ["admin", "ceo"] ||
        request.query.where("riderId", "==", request.auth.uid)
      );

      allow create: if request.auth != null && userRole() in ["admin", "ceo"];

      allow update: if request.auth != null &&
        (
          (resource.data.riderId == request.auth.uid &&
            request.resource.data.diff(resource.data).affectedKeys().hasOnly([
              "status", "lastUpdated", "notes"
            ])
          ) ||
          userRole() in ["admin", "ceo"]
        );

      allow delete: if request.auth != null && userRole() in ["admin", "ceo"];
    }

    // ==========================================
    // ï¿½ðŸš« DENY EVERYTHING ELSE
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
